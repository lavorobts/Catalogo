<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Creazioni D'Arte Eleonora ‚Äì Catalogo</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{--bg1:#fdf5f9;--bg2:#f3e7ff;--accent1:#f7d1e0;--accent2:#c9b7ff;--text:#3b3b3b;}
*{box-sizing:border-box;transition:all .25s ease}
html,body{margin:0;font-family:Inter,system-ui,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);padding:16px;touch-action:manipulation;overscroll-behavior:none;}
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;z-index:10000;flex-direction:column;padding:20px;}
#loginBox{background:#fff;border-radius:20px;padding:40px 30px;box-shadow:0 10px 40px rgba(0,0,0,0.2);text-align:center;max-width:400px;width:100%;animation:slideIn 0.5s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-30px);}to{opacity:1;transform:translateY(0);}}
#loginBox h2{font-family:'Dancing Script',cursive;color:#7a3b6f;font-size:32px;margin:0 0 10px 0;}
#loginBox p{color:#6b6b6b;font-size:14px;margin:0 0 30px 0;}
#passwordInput{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;text-align:center;margin-bottom:15px;transition:border .3s;}
#passwordInput:focus{outline:none;border-color:var(--accent2);}
#loginBtn{width:100%;padding:12px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#fff;font-weight:600;font-size:16px;cursor:pointer;transition:transform .2s;}
#loginBtn:hover{transform:scale(1.02);}
#loginBtn:active{transform:scale(0.98);}
.error-msg{color:#c64d6f;font-size:13px;margin-top:10px;display:none;}
#mainApp{display:none;}
.wrap{max-width:1100px;margin:auto;animation:fadein .6s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
header{display:flex;align-items:center;gap:16px;margin-bottom:20px;}
.logo-preview{width:88px;height:88px;border-radius:16px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:center;background:#f7f3ff;color:#aaa;font-weight:600;font-size:14px;opacity:0;transform:scale(0.9);}
.logo-preview.show{animation:logoEnter .8s ease forwards;}
@keyframes logoEnter{from{opacity:0;transform:scale(0.8) rotate(-3deg);}to{opacity:1;transform:scale(1) rotate(0);}}
.logo-preview img{width:100%;height:100%;object-fit:contain;}
.title{font-family:'Dancing Script',cursive;font-size:30px;color:#7a3b6f;}
.subtitle{color:#6b6b6b;font-size:13px;}
.btn{padding:8px 14px;border-radius:12px;border:0;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#fff;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.btn:hover{box-shadow:0 0 10px rgba(247,209,224,0.8);}
.btn-ghost{padding:8px 14px;border-radius:12px;border:1px dashed rgba(0,0,0,0.1);background:#fff;cursor:pointer;}
.btn-import{padding:8px 14px;border-radius:12px;border:0;background:linear-gradient(135deg,#90EE90,#32CD32);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.btn-import:hover{box-shadow:0 0 10px rgba(144,238,144,0.8);}
.btn-export{padding:8px 14px;border-radius:12px;border:0;background:linear-gradient(135deg,#FFD700,#FFA500);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.btn-export:hover{box-shadow:0 0 10px rgba(255,215,0,0.8);}
.panel{background:#fff;border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 4px 18px rgba(0,0,0,0.08);}
.main{margin-top:10px;}
.section{margin-bottom:10px;border-radius:16px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);background:#fff;}
.section.dragging{opacity:0.6;}
.section .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(90deg,rgba(201,183,255,0.12),rgba(247,209,224,0.12));cursor:grab;}
.section .head h3{margin:0;font-family:'Dancing Script',cursive;font-size:20px;color:#7a3b6f;display:flex;align-items:center;gap:8px;}
.section .head button.del{background:none;border:none;color:#c64d6f;cursor:pointer;font-size:18px;}
.cards{padding:14px;display:none;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;background:#fff;}
.section.open .cards{display:grid;animation:fadecards .3s ease;}
@keyframes fadecards{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
.card{background:#fff;border-radius:12px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,0.05);display:flex;flex-direction:column;gap:8px;cursor:move;touch-action:none;}
.card:hover{box-shadow:0 0 8px rgba(255,175,200,0.5);}
.card.dragging-card{opacity:0.4;transform:scale(0.95);}
.thumb{width:100%;height:200px;border-radius:10px;overflow:hidden;background:#fafafa;display:flex;align-items:center;justify-content:center;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.code{font-weight:700;color:#c64d6f;font-size:14px;}
.note{font-size:13px;color:#6b6b6b;}
.controls{display:flex;gap:8px;align-items:center;justify-content:space-between;}
.qty{width:60px;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center;}
.fav{display:flex;align-items:center;gap:5px;}
.import-export-section{background:#fff3cd;border:2px dashed #ffc107;border-radius:12px;padding:14px;margin-bottom:14px;}
.import-export-section h4{margin:0 0 10px 0;color:#856404;font-family:'Dancing Script',cursive;font-size:20px;}
.button-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
</style>
</head>
<body>

<div id="loginScreen">
  <div id="loginBox">
    <h2>üîí Accesso Riservato</h2>
    <p>Inserisci la password per accedere al generatore</p>
    <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
    <button id="loginBtn">Accedi</button>
    <div class="error-msg" id="errorMsg">‚ùå Password errata!</div>
  </div>
</div>

<div id="mainApp">
<div class="wrap">
<header>
  <div class="logo-preview" id="logoBox"><span>Logo</span><img id="logoImg" alt="logo" style="display:none;"></div>
  <div>
    <div class="title">Creazioni D'Arte Eleonora</div>
    <div class="subtitle">Catalogo Lavori Personalizzati</div>
  </div>
</header>

<div class="import-export-section">
  <h4>üíæ Trasferisci Database</h4>
  <div style="font-size:13px;color:#856404;margin-bottom:10px;">
    Salva e condividi il database per usarlo su altri dispositivi
  </div>
  <div class="button-group">
    <button class="btn-export" id="shareDatabase">üì§ Condividi Database</button>
    <button class="btn-ghost" id="debugDatabase">üîç Verifica Database</button>
    <label class="btn-import">
      üì• Importa Database
      <input id="importDatabase" type="file" accept=".json,application/json" style="display:none;">
    </label>
  </div>
  <div style="font-size:12px;color:#856404;margin-top:8px;">
    üí° Clicca "Condividi" ‚Üí scegli Telegram/WhatsApp/Email ‚Üí invialo a te stesso ‚Üí importa sull'altro dispositivo
  </div>
</div>

<div class="panel">
  <label class="btn">Carica logo<input id="logoInput" type="file" accept="image/*" style="display:none;"></label>
  <input id="newSectionName" placeholder="Nuova sezione (es. Natale)" style="padding:8px;border-radius:8px;border:1px solid #ccc;margin:6px 0;width:60%">
  <button class="btn" id="addSectionBtn">Aggiungi sezione</button>
  <button class="btn-ghost" id="resetStorage">üîÑ Reset catalogo</button>
</div>

<div class="panel">
  <input id="emailDest" placeholder="Email destinatario ordini" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:6px;">
  <button class="btn-ghost" id="exportHtml">üíæ Esporta catalogo (.html)</button>
  <div style="margin-top:8px;font-weight:600;color:#7a3b6f;">Totale lavori: <span id="totaleLavori">0</span></div>
</div>

<main class="main" id="mainContent"></main>
</div>
</div>

<script>
// üîíüîíüîí PASSWORD - CAMBIA QUI! üîíüîíüîí
const PASSWORD_GENERATORE = "cleopatra";
// üîíüîíüîí PASSWORD - CAMBIA QUI! üîíüîíüîí

let sections=[];
let logoData=null;
const main=document.getElementById('mainContent');

document.getElementById('loginBtn').onclick=checkPassword;
document.getElementById('passwordInput').addEventListener('keypress',e=>{if(e.key==='Enter')checkPassword();});

function checkPassword(){
  const input=document.getElementById('passwordInput').value;
  const errorMsg=document.getElementById('errorMsg');
  if(input===PASSWORD_GENERATORE){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainApp').style.display='block';
    initApp();
  }else{
    errorMsg.style.display='block';
    document.getElementById('passwordInput').value='';
    document.getElementById('passwordInput').style.borderColor='#c64d6f';
    setTimeout(()=>{errorMsg.style.display='none';document.getElementById('passwordInput').style.borderColor='#e0e0e0';},2000);
  }
}

function uid(p='id'){return p+'_'+Math.floor(Math.random()*1e9).toString(36);}
function updateTotal(){let t=0;sections.forEach(s=>t+=s.items.length);document.getElementById('totaleLavori').textContent=t;}
function nextCode(){let max=0;sections.forEach(s=>s.items.forEach(i=>{const m=i.code.match(/LAV0*([0-9]+)/);if(m){const n=+m[1];if(n>max)max=n;}}));return max+1;}

function addPhoto(sec){
  const inp=document.createElement('input');
  inp.type='file';inp.multiple=true;inp.accept='image/*';
  inp.onchange=e=>{
    const files=Array.from(e.target.files);
    let loaded=0;
    files.forEach(file=>{
      const r=new FileReader();
      r.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          const max=600;let w=img.width,h=img.height;
          if(w>h&&w>max){h=h*max/w;w=max;}
          else if(h>max){w=w*max/h;h=max;}
          const c=document.createElement('canvas');
          c.width=w;c.height=h;
          const ctx=c.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          const data=c.toDataURL('image/jpeg',0.6);
          sec.items.push({id:uid('it'),img:data,code:'LAV'+String(nextCode()).padStart(3,'0'),note:'',qty:0,fav:false});
          loaded++;
          if(loaded===files.length){render();}
        };
        img.src=ev.target.result;
      };
      r.readAsDataURL(file);
    });
  };
  inp.click();
}

function render(){
  main.innerHTML='';
  sections.forEach(sec=>{
    const s=document.createElement('div');s.className='section';s.draggable=true;
    s.innerHTML=`<div class="head"><h3>${sec.name} (${sec.items.length}) <button class="del" title="Elimina sezione">üóëÔ∏è</button></h3><span>‚ñº</span><button class="btn-ghost" data-id="${sec.id}">Aggiungi foto</button></div><div class="cards"></div>`;
    const grid=s.querySelector('.cards');
    
    sec.items.forEach((it, index)=>{
      const c=document.createElement('div');
      c.className='card';
      c.draggable=true;
      c.dataset.itemId=it.id;
      c.innerHTML=`<div class="thumb"><img src="${it.img}"></div><div class="code">${it.code}</div><div class="note" contenteditable="true">${it.note||'Nota...'}</div><div class="controls"><label class="fav"><input type="checkbox" ${it.fav?'checked':''}> üíï</label><input type="number" value="${it.qty}" min="0" class="qty"></div><button class="btn-ghost del-photo">üóëÔ∏è Elimina foto</button>`;
      grid.appendChild(c);
      
      c.querySelector('.note').oninput=e=>{it.note=e.target.textContent;};
      c.querySelector('input[type=checkbox]').onchange=e=>{it.fav=e.target.checked;};
      c.querySelector('.qty').onchange=e=>{it.qty=parseInt(e.target.value)||0;};
      c.querySelector('.del-photo').onclick=()=>{if(confirm('Vuoi eliminare questa foto?')){sec.items=sec.items.filter(x=>x.id!==it.id);render();}};
      
      // üÜï DRAG AND DROP PER LE FOTO
      c.addEventListener('dragstart', (e) => {
        c.classList.add('dragging-card');
        e.dataTransfer.effectAllowed = 'move';
      });
      
      c.addEventListener('dragend', (e) => {
        c.classList.remove('dragging-card');
        // Riordina l'array items in base all'ordine visuale
        const cards = [...grid.querySelectorAll('.card')];
        sec.items = cards.map(card => {
          const itemId = card.dataset.itemId;
          return sec.items.find(item => item.id === itemId);
        });
      });
      
      c.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggingCard = grid.querySelector('.dragging-card');
        if (!draggingCard || draggingCard === c) return;
        
        const rect = c.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (e.clientY < midY) {
          grid.insertBefore(draggingCard, c);
        } else {
          grid.insertBefore(draggingCard, c.nextSibling);
        }
      });
      
      // üÜï TOUCH SUPPORT per mobile
      let touchStartY = 0;
      let touchStartX = 0;
      let isDragging = false;
      let clone = null;
      
      c.addEventListener('touchstart', (e) => {
        // Non iniziare drag se si sta interagendo con input/button
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('.note')) {
          return;
        }
        
        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
        
        setTimeout(() => {
          if (!isDragging) {
            isDragging = true;
            c.classList.add('dragging-card');
            
            // Crea clone visuale
            clone = c.cloneNode(true);
            clone.style.position = 'fixed';
            clone.style.zIndex = '10000';
            clone.style.pointerEvents = 'none';
            clone.style.width = c.offsetWidth + 'px';
            clone.style.opacity = '0.8';
            document.body.appendChild(clone);
            updateClonePosition(e.touches[0]);
          }
        }, 200); // Long press di 200ms
      });
      
      c.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        
        updateClonePosition(e.touches[0]);
        
        // Trova la card sotto il dito
        const touch = e.touches[0];
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const cardBelow = elementBelow?.closest('.card');
        
        if (cardBelow && cardBelow !== c && cardBelow.parentElement === grid) {
          const rect = cardBelow.getBoundingClientRect();
          const midY = rect.top + rect.height / 2;
          
          if (touch.clientY < midY) {
            grid.insertBefore(c, cardBelow);
          } else {
            grid.insertBefore(c, cardBelow.nextSibling);
          }
        }
      });
      
      c.addEventListener('touchend', (e) => {
        if (isDragging) {
          isDragging = false;
          c.classList.remove('dragging-card');
          
          if (clone) {
            clone.remove();
            clone = null;
          }
          
          // Salva il nuovo ordine
          const cards = [...grid.querySelectorAll('.card')];
          sec.items = cards.map(card => {
            const itemId = card.dataset.itemId;
            return sec.items.find(item => item.id === itemId);
          });
        }
      });
      
      function updateClonePosition(touch) {
        if (clone) {
          clone.style.left = (touch.clientX - c.offsetWidth / 2) + 'px';
          clone.style.top = (touch.clientY - 50) + 'px';
        }
      }
    });
    
    s.querySelector('.head').addEventListener('click',e=>{if(e.target.tagName==='BUTTON'&&!e.target.classList.contains('del'))return;s.classList.toggle('open');});
    s.querySelector('.btn-ghost').onclick=()=>addPhoto(sec);
    s.querySelector('.del').onclick=()=>{if(confirm('Vuoi eliminare la sezione "'+sec.name+'"?')){sections=sections.filter(x=>x.id!==sec.id);render();}};
    s.addEventListener('dragstart',()=>s.classList.add('dragging'));
    s.addEventListener('dragend',()=>{s.classList.remove('dragging');});
    main.appendChild(s);
  });
  updateTotal();
  enableDrag();
}

function enableDrag(){
  main.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=document.querySelector('.dragging');
    if(!dragging)return;
    const after=getDragAfterElement(main,e.clientY);
    if(after==null)main.appendChild(dragging);else main.insertBefore(dragging,after);
    sections=[...main.querySelectorAll('.section')].map(s=>{const id=s.querySelector('.btn-ghost').dataset.id;return sections.find(x=>x.id===id);});
  });
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.section:not(.dragging)')];
  return els.reduce((closest,child)=>{const box=child.getBoundingClientRect();const offset=y-box.top-box.height/2;if(offset<0&&offset>closest.offset){return{offset:offset,element:child};}else return closest;},{offset:Number.NEGATIVE_INFINITY}).element;
}

document.getElementById('debugDatabase').onclick=()=>{
  const totalSections=sections.length;
  const totalPhotos=sections.reduce((tot,s)=>tot+s.items.length,0);
  let report=`üìä STATO DATABASE:\n\nüì¶ Sezioni: ${totalSections}\nüì∏ Foto totali: ${totalPhotos}\n\n`;
  sections.forEach((sec,idx)=>{report+=`${idx+1}. ${sec.name}: ${sec.items.length} foto\n`;sec.items.forEach((item,i)=>{const hasImg=item.img&&item.img.length>0;const imgSize=hasImg?(item.img.length/1024).toFixed(1)+' KB':'MANCANTE';report+=`   - ${item.code}: ${hasImg?'‚úÖ':'‚ùå'} (${imgSize})\n`;});});
  const database={version:'1.0',exportDate:new Date().toISOString(),logo:logoData,email:document.getElementById('emailDest').value,sections:sections};
  const dataStr=JSON.stringify(database);
  const sizeInMB=(dataStr.length/1024/1024).toFixed(2);
  report+=`\nüíæ Dimensione export: ${sizeInMB} MB`;
  alert(report);
  console.log('DATABASE COMPLETO:',database);
};

document.getElementById('shareDatabase').onclick=async()=>{
  try{
    const database={version:'1.0',exportDate:new Date().toISOString(),logo:logoData,email:document.getElementById('emailDest').value,sections:sections};
    const totalPhotos=sections.reduce((tot,s)=>tot+s.items.length,0);
    const dataStr=JSON.stringify(database);
    const sizeInMB=(dataStr.length/1024/1024).toFixed(2);
    if(totalPhotos===0){alert('‚ö†Ô∏è Non ci sono foto da esportare!\n\nAggiungi almeno una foto prima di esportare.');return;}
    if(dataStr.length>50000000){alert(`‚ö†Ô∏è Database troppo grande (${sizeInMB} MB)!\n\nüì∏ Hai ${totalPhotos} foto.\n\nRiduci il numero di foto.`);return;}
    const blob=new Blob([dataStr],{type:'application/json'});
    const fileName=`catalogo_eleonora_${new Date().toISOString().split('T')[0]}.json`;
    const file=new File([blob],fileName,{type:'application/json'});
    if(navigator.share){
      try{
        await navigator.share({title:'Database Catalogo Eleonora',text:`üì∏ ${totalPhotos} foto - ${sizeInMB} MB`,files:[file]});
        alert('‚úÖ Perfetto!\n\nOra:\n1Ô∏è‚É£ Scarica il file che ti sei inviato\n2Ô∏è‚É£ Apri il generatore sull\'altro dispositivo\n3Ô∏è‚É£ Clicca "üì• Importa Database"\n4Ô∏è‚É£ Seleziona il file');
        return;
      }catch(err){if(err.name==='AbortError')return;}
    }
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=fileName;document.body.appendChild(a);a.click();document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(url),100);
    alert(`‚úÖ File scaricato (${sizeInMB} MB - ${totalPhotos} foto)!\n\nTrova il file in Download e invialo a te stesso via Telegram/WhatsApp/Email`);
  }catch(err){alert('‚ùå Errore: '+err.message);}
};

document.getElementById('importDatabase').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  if(!confirm('‚ö†Ô∏è L\'importazione sostituir√† tutti i dati attuali. Continuare?')){e.target.value='';return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const database=JSON.parse(ev.target.result);
      if(!database.sections||!Array.isArray(database.sections)){throw new Error('File non valido: manca sections');}
      sections=database.sections;logoData=database.logo||null;
      if(logoData){document.getElementById('logoImg').src=logoData;document.getElementById('logoImg').style.display='block';document.querySelector('#logoBox span').style.display='none';}else{document.getElementById('logoImg').style.display='none';document.querySelector('#logoBox span').style.display='block';}
      if(database.email){document.getElementById('emailDest').value=database.email;}
      render();
      const totalPhotos=sections.reduce((tot,s)=>tot+s.items.length,0);
      alert('‚úÖ Database importato con successo!\n\n'+`üì¶ Sezioni: ${sections.length}\n`+`üì∏ Foto: ${totalPhotos}\n`+`üìÖ ${new Date(database.exportDate).toLocaleDateString('it-IT')}`);
    }catch(err){alert('‚ùå Errore importazione:\n'+err.message);}
    e.target.value='';
  };
  reader.readAsText(file);
};

document.getElementById('addSectionBtn').onclick=()=>{
  const n=document.getElementById('newSectionName').value.trim();
  if(!n)return alert('Scrivi un nome sezione!');
  sections.push({id:uid('sec'),name:n,items:[]});
  document.getElementById('newSectionName').value='';
  render();
};

document.getElementById('newSectionName').addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('addSectionBtn').click();}});

document.getElementById('logoInput').onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=a=>{
    logoData=a.target.result;
    const img=document.getElementById('logoImg');
    img.src=logoData;
    img.style.display='block';
    document.querySelector('#logoBox span').style.display='none';
  };
  r.readAsDataURL(f);
};

document.getElementById('resetStorage').onclick=()=>{
  if(confirm('Eliminare tutto e ricominciare da zero?')){sections=[];logoData=null;location.reload();}
};

document.getElementById('exportHtml').onclick=()=>{
  const email=document.getElementById('emailDest').value||'';
  const clienteHtml=`<!DOCTYPE html><html lang="it"><head><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Catalogo Cliente</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,Arial;background:linear-gradient(135deg,#fdf5f9,#f3e7ff);color:#333;padding:10px;}
    section{border:1px solid #eee;border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,0.05);}
    .head{background:rgba(201,183,255,0.15);padding:8px;display:flex;justify-content:space-between;cursor:pointer;}
    .cards{display:none;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;padding:10px;}
    section.open .cards{display:grid;}
    img{max-width:100%;border-radius:10px;}
    .btn{padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(135deg,#c9b7ff,#f7d1e0);color:#fff;font-weight:600;cursor:pointer;display:block;margin:10px auto;}
    .logoBox{width:120px;height:120px;margin:0 auto 10px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:#f7f3ff;}
    .logoBox img{max-width:100%;max-height:100%;object-fit:contain;}
    input[type=number]{width:60px;padding:4px;border:1px solid #ccc;border-radius:6px;text-align:center;}
    #intro{position:fixed;inset:0;background:linear-gradient(135deg,#fdf5f9,#f3e7ff);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;animation:fadeOut 1s ease 2.5s forwards;}
    #intro img{width:280px;height:280px;object-fit:contain;opacity:0;animation:logoIn 1.2s ease forwards;}
    @keyframes logoIn{0%{opacity:0;transform:scale(0.8);}100%{opacity:1;transform:scale(1);}}
    @keyframes fadeOut{to{opacity:0;visibility:hidden;}}
    #content{opacity:0;animation:showContent 1s ease 2.5s forwards;}
    @keyframes showContent{to{opacity:1;}}
  </style></head><body>
  <div id="intro">
    ${logoData?`<img src="${logoData}">`:`<div style="font-family:'Dancing Script',cursive;font-size:28px;color:#7a3b6f;">Creazioni D'Arte Eleonora</div>`}
  </div>
  <div id="content">
  ${logoData?`<div class="logoBox"><img src="${logoData}"></div>`:`<div class="logoBox">Logo</div>`}
  <h1 style="font-family:'Dancing Script',cursive;color:#7a3b6f;text-align:center">Creazioni D'Arte Eleonora</h1>
  <input id="clienteNome" placeholder="Nome cliente" style="width:60%;padding:8px;border:1px solid #ccc;border-radius:8px;display:block;margin:10px auto;text-align:center;font-weight:600;color:#7a3b6f;">
  ${sections.map(sec=>`<section><div class="head"><h3 style="margin:0;font-family:'Dancing Script',cursive;color:#7a3b6f">${sec.name}</h3><span>‚ñº</span></div><div class="cards">
  ${sec.items.map(it=>`<div style="background:#fff;padding:6px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.05)">
  <img src="${it.img}"><div style="font-weight:700;color:#c64d6f">${it.code}</div><div>${it.note||''}</div>
  <div><label><input type="checkbox"> üíï</label> <input type="number" min="0" value="${it.qty}" class="qty-input" style="width:60px"></div></div>`).join('')}
  </div></section>`).join('')}
  <button class="btn" id="sendWhats">üì© Invia selezione su WhatsApp</button>
  <button class="btn" id="sendEmail">üìß Invia via Email</button>
  </div>
  <script>
  document.querySelectorAll('.head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
  document.addEventListener('DOMContentLoaded',function(){
    document.querySelectorAll('.qty-input').forEach(input=>{
      input.addEventListener('focus',function(e){setTimeout(()=>{this.select();this.setSelectionRange(0,9999);},10);});
      input.addEventListener('click',function(e){setTimeout(()=>{this.select();this.setSelectionRange(0,9999);},10);});
      input.addEventListener('touchstart',function(e){setTimeout(()=>{this.select();this.setSelectionRange(0,9999);},100);});
      input.addEventListener('mousedown',function(e){if(this.value!==''){setTimeout(()=>{this.select();this.setSelectionRange(0,9999);},10);}});
    });
  });
  function genMsg(){
    const nome=document.getElementById('clienteNome').value.trim();
    let msg='Ordine'+(nome?' di '+nome:'')+'%0A%0A';
    document.querySelectorAll('section').forEach(sec=>{
      sec.querySelectorAll('.cards > div').forEach(card=>{
        const chk=card.querySelector('input[type=checkbox]');
        if(chk.checked){
          const code=card.querySelector('div:nth-child(2)').innerText;
          const note=card.querySelector('div:nth-child(3)').innerText;
          const qty=card.querySelector('input[type=number]').value;
          msg+=code+' ‚Äì '+note+' (x'+qty+')%0A';
        }
      });
    });
    return msg;
  }
  document.getElementById('sendWhats').onclick=()=>{const m=genMsg();window.open('https://wa.me/?text='+m,'_blank');};
  document.getElementById('sendEmail').onclick=()=>{const m=genMsg();window.location.href='mailto:${email}?subject=Ordine Creazioni D\\'Arte Eleonora&body='+m.replace(/%0A/g,'%0D%0A');};
  <\/script></body></html>`;
  const blob=new Blob([clienteHtml],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='catalogo_cliente.html';
  a.click();
};

function initApp(){
  const logoBox=document.getElementById("logoBox");
  if(logoBox){requestAnimationFrame(()=>logoBox.classList.add("show"));}
  if(sections.length===0){sections=[{id:uid('sec'),name:'Natale',items:[]}];}
  render();
}
</script>
</body>
</html>